From d1d48ef8bdac76a4d7696ca55135897cb8c64ec3 Mon Sep 17 00:00:00 2001
From: Oleksandr Iegorov <oiegorov@magento.com>
Date: Mon, 27 Jan 2020 14:59:29 -0600
Subject: [PATCH 1/7] MC-18280: Dynamic Block based on segment not displaying
 correctly for visitor

---
 .../Banner/view/frontend/web/js/model/banner.js | 17 ++++++++++++++++-
 1 file changed, 16 insertions(+), 1 deletion(-)

diff --git a/vendor/magento/module-banner/view/frontend/web/js/model/banner.js b/vendor/magento/module-banner/view/frontend/web/js/model/banner.js
index 5dced947634..b79addef41f 100644
--- a/vendor/magento/module-banner/view/frontend/web/js/model/banner.js
+++ b/vendor/magento/module-banner/view/frontend/web/js/model/banner.js
@@ -26,16 +26,31 @@ define([
         invalidateCacheBySessionTimeOut = function () {
             var cacheEol = new Date($.localStorage.get('mage-banners-cache-timeout')),
                 dateTo = new Date(Date.now() + options.cacheTtl),
+                cartDataId = 0,
                 globalStoreId = $.cookieStorage.get('store') || 'default';
 
             if ($.localStorage.get('mage-banners-storeId') === null) {
                 $.localStorage.set('mage-banners-storeId', globalStoreId);
             }
 
-            if (cacheEol < new Date() || $.localStorage.get('mage-banners-storeId') !== globalStoreId) {
+            if ($.localStorage.get('mage-banners-cartDataId') === null && cartDataId > 0) {
+                $.localStorage.set('mage-banners-cartDataId', cartDataId);
+            }
+
+            if ($.localStorage.get('mage-cache-storage').hasOwnProperty('cart')) {
+                cartDataId = $.localStorage.get('mage-cache-storage').cart['data_id'];
+            }
+
+            if (cacheEol < new Date() ||
+                $.localStorage.get('mage-banners-storeId') !== globalStoreId ||
+                $.localStorage.get('mage-banners-cartDataId') !== cartDataId) {
                 storage.removeAll();
                 $.localStorage.set('mage-banners-cache-timeout', dateTo);
                 $.localStorage.set('mage-banners-storeId', globalStoreId);
+
+                if (cartDataId > 0) {
+                    $.localStorage.set('mage-banners-cartDataId', cartDataId);
+                }
             }
         },
         dataProvider = {

From 888156449c5ba0e884f5111f271aff9b317d2571 Mon Sep 17 00:00:00 2001
From: Oleksandr Iegorov <oiegorov@magento.com>
Date: Tue, 28 Jan 2020 10:01:55 -0600
Subject: [PATCH 2/7] MC-18280: Dynamic Block based on segment not displaying
 correctly for visitor

---
 .../CustomerSegment/Model/Customer.php        | 30 +++++--------------
 1 file changed, 8 insertions(+), 22 deletions(-)

diff --git a/vendor/magento/module-customer-segment/Model/Customer.php b/vendor/magento/module-customer-segment/Model/Customer.php
index aa6d1e271ad..3f7c87cabf9 100644
--- a/vendor/magento/module-customer-segment/Model/Customer.php
+++ b/vendor/magento/module-customer-segment/Model/Customer.php
@@ -23,6 +23,7 @@
  * @method int getWebsiteId()
  * @method Customer setWebsiteId(int $value)
  * @SuppressWarnings(PHPMD.CouplingBetweenObjects)
+ * @SuppressWarnings(PHPMD.CookieAndSessionMisuse)
  * @api
  * @since 100.0.2
  */
@@ -411,6 +412,8 @@ public function getCurrentCustomerSegmentIds()
         /** @var \Magento\Customer\Model\Session $customerSession */
         $customerSession = $this->_customerSession;
 
+        $result = [];
+
         /** @var \Magento\Customer\Model\Customer $customer */
         $customer = $this->_registry->registry('segment_customer');
         if (!$customer) {
@@ -418,33 +421,16 @@ public function getCurrentCustomerSegmentIds()
         }
         $websiteId = $this->_storeManager->getWebsite()->getId();
         if (!$customer->getId()) {
-            $result = $this->getVisitorsSegmentsForWebsite($websiteId);
+            $allSegmentIds = $customerSession->getCustomerSegmentIds();
+            if (is_array($allSegmentIds) && isset($allSegmentIds[$websiteId])) {
+                $result = $allSegmentIds[$websiteId];
+            }
         } else {
             $result = $this->getCustomerSegmentIdsForWebsite(
                 $customer->getId(),
-                $this->_storeManager->getWebsite()->getId()
+                $websiteId
             );
         }
         return $result;
     }
-
-    /**
-     * Return all segments applied for visitors
-     *
-     * @param int $websiteId
-     * @return array
-     */
-    private function getVisitorsSegmentsForWebsite(int $websiteId): array
-    {
-        /** @var \Magento\CustomerSegment\Model\ResourceModel\Segment\Collection $collection */
-        $collection = $this->_collectionFactory->create();
-        $collection->addWebsiteFilter($websiteId);
-        $collection->addFieldToFilter(
-            'apply_to',
-            [Segment::APPLY_TO_VISITORS, Segment::APPLY_TO_VISITORS_AND_REGISTERED]
-        );
-        $collection->addIsActiveFilter(1);
-
-        return $collection->getAllIds();
-    }
 }

From 01bdd2fbe3cd5d81c1621a8fc17891e5ff6b946a Mon Sep 17 00:00:00 2001
From: Oleksandr Iegorov <oiegorov@magento.com>
Date: Tue, 28 Jan 2020 10:03:51 -0600
Subject: [PATCH 3/7] MC-18280: Dynamic Block based on segment not displaying
 correctly for visitor

---
 .../Model/Segment/Condition/Shoppingcart/Amount.php  | 12 +++++++-----
 1 file changed, 7 insertions(+), 5 deletions(-)

diff --git a/vendor/magento/module-customer-segment/Model/Segment/Condition/Shoppingcart/Amount.php b/vendor/magento/module-customer-segment/Model/Segment/Condition/Shoppingcart/Amount.php
index 3d21fc555f6..d8fec90cb85 100644
--- a/vendor/magento/module-customer-segment/Model/Segment/Condition/Shoppingcart/Amount.php
+++ b/vendor/magento/module-customer-segment/Model/Segment/Condition/Shoppingcart/Amount.php
@@ -229,11 +229,13 @@ private function executeSql($customer, $websiteId, $params, $isFiltered = true)
         } else {
             $select->from(['quote' => $table], ['customer_id'])->where('quote.is_active=1');
         }
-        $select->joinInner(
-            ['customer' => $customerTable],
-            'quote.customer_id = customer.entity_id',
-            []
-        );
+        if ($customer) {
+            $select->joinInner(
+                ['customer' => $customerTable],
+                'quote.customer_id = customer.entity_id',
+                []
+            );
+        }
 
         $select->where(
             'quote.store_id IN(?)',

From 3dc554fcd2693aa33fc551f7b81ceb2be11c95b2 Mon Sep 17 00:00:00 2001
From: Oleksandr Iegorov <oiegorov@magento.com>
Date: Tue, 28 Jan 2020 13:13:27 -0600
Subject: [PATCH 4/7] MC-18280: Dynamic Block based on segment not displaying
 correctly for visitor

---
 .../Test/Unit/Model/CustomerTest.php          | 21 ++++++++++++-------
 1 file changed, 13 insertions(+), 8 deletions(-)

diff --git a/vendor/magento/module-customer-segment/Test/Unit/Model/CustomerTest.php b/vendor/magento/module-customer-segment/Test/Unit/Model/CustomerTest.php
index fb3d525d74c..1af12637ced 100644
--- a/vendor/magento/module-customer-segment/Test/Unit/Model/CustomerTest.php
+++ b/vendor/magento/module-customer-segment/Test/Unit/Model/CustomerTest.php
@@ -58,11 +58,16 @@ class CustomerTest extends \PHPUnit\Framework\TestCase
      */
     private $_fixtureSegmentIds = [123, 456];
 
+    /**
+     * @var int
+     */
+    private $websiteId = 5;
+
     protected function setUp()
     {
         $this->_registry = $this->createPartialMock(\Magento\Framework\Registry::class, ['registry']);
 
-        $website = new \Magento\Framework\DataObject(['id' => 5]);
+        $website = new \Magento\Framework\DataObject(['id' => $this->websiteId]);
         $storeManager = $this->createMock(\Magento\Store\Model\StoreManagerInterface::class);
         $storeManager->expects($this->any())->method('getWebsite')->will($this->returnValue($website));
 
@@ -173,9 +178,9 @@ public function testGetCurrentCustomerSegmentIdsCustomerInRegistryNoId(): void
             ->method('registry')
             ->with('segment_customer')
             ->will($this->returnValue($customer));
-        $this->collection->expects($this->once())
-            ->method('getAllIds')
-            ->willReturn($this->_fixtureSegmentIds);
+        $this->_customerSession->expects($this->once())
+            ->method('getCustomerSegmentIds')
+            ->willReturn([$this->websiteId => $this->_fixtureSegmentIds]);
 
         $this->assertEquals($this->_fixtureSegmentIds, $this->model->getCurrentCustomerSegmentIds());
     }
@@ -206,9 +211,9 @@ public function testGetCurrentCustomerSegmentIdsCustomerInSessionNoId(): void
         $this->_customerSession->expects($this->once())
             ->method('getCustomer')
             ->willReturn($customer);
-        $this->collection->expects($this->once())
-            ->method('getAllIds')
-            ->willReturn($this->_fixtureSegmentIds);
+        $this->_customerSession->expects($this->once())
+            ->method('getCustomerSegmentIds')
+            ->willReturn([$this->websiteId => $this->_fixtureSegmentIds]);
         $this->assertEquals($this->_fixtureSegmentIds, $this->model->getCurrentCustomerSegmentIds());
     }
 
@@ -373,7 +378,7 @@ public function testAddCustomerToWebsiteSegments(
 
         $this->model->addCustomerToWebsiteSegments($customerId, $websiteId, $segmentIds);
     }
-    
+
     public function dataProviderRemoveVisitorFromWebsiteSegments()
     {
         return [

From 8d0b91c3956cad0e69f1ffb89a633a37a861a7eb Mon Sep 17 00:00:00 2001
From: Oleksandr Iegorov <oiegorov@magento.com>
Date: Tue, 28 Jan 2020 13:22:46 -0600
Subject: [PATCH 5/7] MC-18280: Dynamic Block based on segment not displaying
 correctly for visitor

---
 .../Banner/Test/Mftf/Test/AdminAddNestedBannerWithImageTest.xml | 2 +-
 .../Test/Mftf/Test/AdminAddVariableToWYSIWYGBannerCest.xml      | 2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/vendor/magento/module-banner/Test/Mftf/Test/AdminAddNestedBannerWithImageTest.xml b/vendor/magento/module-banner/Test/Mftf/Test/AdminAddNestedBannerWithImageTest.xml
index 9fcc1e5a5ab..32d31b5e403 100644
--- a/vendor/magento/module-banner/Test/Mftf/Test/AdminAddNestedBannerWithImageTest.xml
+++ b/vendor/magento/module-banner/Test/Mftf/Test/AdminAddNestedBannerWithImageTest.xml
@@ -121,7 +121,7 @@
         <amOnPage url="{{_defaultCmsPage.identifier}}" stepKey="amOnPageTestPage"/>
         <waitForPageLoad stepKey="waitForTestPageToLoad" time="20"/>
         <!--see content of the dynamic block on Storefront-->
-        <waitForElementVisible selector="{{StorefrontBannerSection.targetImage}}" stepKey="waitForImage" />
+        <waitForElementVisible selector="{{StorefrontBannerSection.targetImage}}" time="35" stepKey="waitForImage" />
         <seeElement selector="{{StorefrontBannerSection.targetImage}}" stepKey="assertBannerImage"/>
         <seeElementInDOM selector="{{StorefrontBannerSection.ImageSource(ImageUpload.fileName,ImageUpload.extension)}}" stepKey="assertMediaSource"/>
     </test>
diff --git a/vendor/magento/module-banner/Test/Mftf/Test/AdminAddVariableToWYSIWYGBannerCest.xml b/vendor/magento/module-banner/Test/Mftf/Test/AdminAddVariableToWYSIWYGBannerCest.xml
index cf3300603a2..1fdbbd93e8c 100644
--- a/vendor/magento/module-banner/Test/Mftf/Test/AdminAddVariableToWYSIWYGBannerCest.xml
+++ b/vendor/magento/module-banner/Test/Mftf/Test/AdminAddVariableToWYSIWYGBannerCest.xml
@@ -96,7 +96,7 @@
         <!-- Go to storefront banner page, assert banner content -->
         <amOnPage url="/" stepKey="goToBannerFrontPage" />
         <waitForPageLoad stepKey="waitForPageLoad10"/>
-        <waitForText userInput="Sample Variable Hello World from banner!" stepKey="waitForText"/>
+        <waitForText userInput="Sample Variable Hello World from banner!" time="35" stepKey="waitForText"/>
         <see userInput="Sample Variable Hello World from banner!" stepKey="assertBannerDescription"/>
     </test>
 </tests>

From 4c0f67ab8836dcbe9e8ab421d6fee32814a99fb7 Mon Sep 17 00:00:00 2001
From: Oleksandr Iegorov <oiegorov@magento.com>
Date: Wed, 29 Jan 2020 11:16:28 -0600
Subject: [PATCH 6/7] MC-18280: Dynamic Block based on segment not displaying
 correctly for visitor

---
 .../Test/Mftf/Test/AdminAddNestedBannerWithImageTest.xml       | 2 +-
 .../Test/Mftf/Test/AdminAddVariableToWYSIWYGBannerCest.xml     | 2 +-
 vendor/magento/module-banner/view/frontend/web/js/model/banner.js   | 3 ++-
 3 files changed, 4 insertions(+), 3 deletions(-)

diff --git a/vendor/magento/module-banner/Test/Mftf/Test/AdminAddNestedBannerWithImageTest.xml b/vendor/magento/module-banner/Test/Mftf/Test/AdminAddNestedBannerWithImageTest.xml
index 32d31b5e403..9fcc1e5a5ab 100644
--- a/vendor/magento/module-banner/Test/Mftf/Test/AdminAddNestedBannerWithImageTest.xml
+++ b/vendor/magento/module-banner/Test/Mftf/Test/AdminAddNestedBannerWithImageTest.xml
@@ -121,7 +121,7 @@
         <amOnPage url="{{_defaultCmsPage.identifier}}" stepKey="amOnPageTestPage"/>
         <waitForPageLoad stepKey="waitForTestPageToLoad" time="20"/>
         <!--see content of the dynamic block on Storefront-->
-        <waitForElementVisible selector="{{StorefrontBannerSection.targetImage}}" time="35" stepKey="waitForImage" />
+        <waitForElementVisible selector="{{StorefrontBannerSection.targetImage}}" stepKey="waitForImage" />
         <seeElement selector="{{StorefrontBannerSection.targetImage}}" stepKey="assertBannerImage"/>
         <seeElementInDOM selector="{{StorefrontBannerSection.ImageSource(ImageUpload.fileName,ImageUpload.extension)}}" stepKey="assertMediaSource"/>
     </test>
diff --git a/vendor/magento/module-banner/Test/Mftf/Test/AdminAddVariableToWYSIWYGBannerCest.xml b/vendor/magento/module-banner/Test/Mftf/Test/AdminAddVariableToWYSIWYGBannerCest.xml
index 1fdbbd93e8c..cf3300603a2 100644
--- a/vendor/magento/module-banner/Test/Mftf/Test/AdminAddVariableToWYSIWYGBannerCest.xml
+++ b/vendor/magento/module-banner/Test/Mftf/Test/AdminAddVariableToWYSIWYGBannerCest.xml
@@ -96,7 +96,7 @@
         <!-- Go to storefront banner page, assert banner content -->
         <amOnPage url="/" stepKey="goToBannerFrontPage" />
         <waitForPageLoad stepKey="waitForPageLoad10"/>
-        <waitForText userInput="Sample Variable Hello World from banner!" time="35" stepKey="waitForText"/>
+        <waitForText userInput="Sample Variable Hello World from banner!" stepKey="waitForText"/>
         <see userInput="Sample Variable Hello World from banner!" stepKey="assertBannerDescription"/>
     </test>
 </tests>
diff --git a/vendor/magento/module-banner/view/frontend/web/js/model/banner.js b/vendor/magento/module-banner/view/frontend/web/js/model/banner.js
index b79addef41f..65d63364c82 100644
--- a/vendor/magento/module-banner/view/frontend/web/js/model/banner.js
+++ b/vendor/magento/module-banner/view/frontend/web/js/model/banner.js
@@ -37,7 +37,8 @@ define([
                 $.localStorage.set('mage-banners-cartDataId', cartDataId);
             }
 
-            if ($.localStorage.get('mage-cache-storage').hasOwnProperty('cart')) {
+            if ($.localStorage.get('mage-cache-storage') !== null
+                && $.localStorage.get('mage-cache-storage').hasOwnProperty('cart')) {
                 cartDataId = $.localStorage.get('mage-cache-storage').cart['data_id'];
             }
 

From 02ca5f211ffe4d38ffc8670bc348349e8e21b63e Mon Sep 17 00:00:00 2001
From: Oleksandr Iegorov <oiegorov@magento.com>
Date: Wed, 29 Jan 2020 11:46:52 -0600
Subject: [PATCH 7/7] MC-18280: Dynamic Block based on segment not displaying
 correctly for visitor

---
 vendor/magento/module-banner/view/frontend/web/js/model/banner.js | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/vendor/magento/module-banner/view/frontend/web/js/model/banner.js b/vendor/magento/module-banner/view/frontend/web/js/model/banner.js
index 65d63364c82..32cc02903fd 100644
--- a/vendor/magento/module-banner/view/frontend/web/js/model/banner.js
+++ b/vendor/magento/module-banner/view/frontend/web/js/model/banner.js
@@ -37,8 +37,8 @@ define([
                 $.localStorage.set('mage-banners-cartDataId', cartDataId);
             }
 
-            if ($.localStorage.get('mage-cache-storage') !== null
-                && $.localStorage.get('mage-cache-storage').hasOwnProperty('cart')) {
+            if ($.localStorage.get('mage-cache-storage') !== null &&
+                $.localStorage.get('mage-cache-storage').hasOwnProperty('cart')) {
                 cartDataId = $.localStorage.get('mage-cache-storage').cart['data_id'];
             }
 